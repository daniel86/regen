<?xml version="1.0" encoding="UTF-8" ?>
<TextureUpdater
    name="fluid 256x256"
    framerate="160"
    TIMESTEP="0.125"
>
    <!-- Named buffers used in fLuid simulation. -->
    <buffers>
        <buffer name="velocity"   components="2" count="2"
            pixelType="GL_HALF_FLOAT" size="256,256" />
        <buffer name="pressure"   components="1" count="2"
            pixelType="GL_HALF_FLOAT" size="256,256" />
        <buffer name="divergence" components="1" count="1"
            pixelType="GL_HALF_FLOAT" size="256,256" />
        <!-- yz is used as obstacle velocity. -->
        <buffer name="obstacles"  components="3" count="1"
            pixelType="GL_HALF_FLOAT" size="256,256" />
        <buffer name="output"      components="3" count="1"
            pixelType="GL_UNSIGNED_BYTE" size="256,256" />
    </buffers>

    <init>
        <!-- splat obstacles -->
        <!-- the border keeps the fluid from escaping. -->
        <operation
            shader="fluid.splat.border"
            IGNORE_OBSTACLES="TRUE"
            in_splatBorder="1.0"
            in_splatValue="1.0,0.0,0.0"
            out="obstacles" />
        <operation
            shader="fluid.splat.rect"
            blend="add"
            IGNORE_OBSTACLES="TRUE"
            in_splatPoint="135.0,128.0"
            in_splatSize="10.0,90.0"
            in_splatValue="1.0,0.0,0.0"
            out="obstacles" />
        <operation
            shader="fluid.splat.rect"
            blend="add"
            IGNORE_OBSTACLES="TRUE"
            in_splatPoint="105.0,180.0"
            in_splatSize="10.0,90.0"
            in_splatValue="1.0,0.0,0.0"
            out="obstacles" />
        <operation
            shader="fluid.splat.rect"
            blend="add"
            IGNORE_OBSTACLES="TRUE"
            in_splatPoint="110.0,190.0"
            in_splatSize="70.0,10.0"
            in_splatValue="1.0,0.0,0.0"
            out="obstacles" />
    </init>
    
    <loop>
        <!-- Advection transports quantities in the medium. -->
        <operation
            shader="fluid.advect"
            in_decayAmount="1.0"
            in_quantityLoss="0.0"
            in_velocityBuffer="velocity"
            in_quantityBuffer="velocity"
            in_obstaclesBuffer="obstacles"
            out="velocity" />

        <!-- splat velocity -->
        <operation
            shader="fluid.splat.circle"
            blend="add"
            in_splatPoint="128.0,0.0"
            in_splatRadius="12.8"
            in_splatValue="0.0,1.0"
            in_obstaclesBuffer="obstacles"
            out="velocity" />

        <!-- The pressure solve -->
        <operation
            shader="fluid.divergence"
            in_halfInverseCellSize="0.4"
            in_velocityBuffer="velocity"
            in_obstaclesBuffer="obstacles"
            out="divergence" />
        <operation
            shader="fluid.pressure"
            iterations="20"
            clearColor="0.0"
            in_alpha="-1.5625"
            in_inverseBeta="0.25"
            in_pressureBuffer="pressure"
            in_divergenceBuffer="divergence"
            in_obstaclesBuffer="obstacles"
            out="pressure" />
        <operation
            shader="fluid.substractGradient"
            in_gradientScale="0.9"
            in_velocityBuffer="velocity"
            in_pressureBuffer="pressure"
            in_obstaclesBuffer="obstacles"
            out="velocity" />
            
        <!-- draw velocity -->
        <operation
            shader="fluid.sample.velocity"
            blend="srcAlpha"
            in_texelFactor="1.0"
            in_quantity="velocity"
            out="output" />
        <!-- draw obstacles -->
        <operation
            shader="fluid.sample.scalar"
            blend="alpha"
            in_quantity="obstacles"
            in_texelFactor="1.0"
            in_colorPositive="0.8,0.7,0.6"
            in_colorNegative="0.0"
            out="output" /> 
    </loop>
</texture-updater>

