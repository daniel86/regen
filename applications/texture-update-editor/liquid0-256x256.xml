<?xml version="1.0" encoding="UTF-8" ?>

<texture-updater
    name="liquid 256x256"
    framerate="160"
    TIMESTEP="0.125"
    IS_LIQUID="1"
>
    <!-- Named buffers used in fLuid simulation. -->
    <buffers>
        <buffer name="velocity"
                components="2" count="2"
                pixelType="16F" size="256,256" />
        <buffer name="pressure"
                components="1" count="2"
                pixelType="16F" size="256,256" />
        <buffer name="divergence"
                components="2" count="1"
                pixelType="16F" size="256,256" />
        <buffer name="levelSet"
                components="1" count="2"
                pixelType="16F" size="256,256" />
        <buffer name="initialLevelSet"
                components="1" count="2"
                pixelType="16F" size="256,256" />
        <buffer name="obstacles"
                components="3" count="1"
                pixelType="16F" size="256,256" />
        <buffer name="output"
                components="3" count="1"
                pixelType="16F" size="256,256" />
    </buffers>

    <init>
        <!-- Adds obstacles -->
        <operation
            fs="fluid.splat.border"
            IGNORE_OBSTACLES="1"
            in_splatBorder="1.0"
            in_splatValue="1.0,0.0,0.0"
            out="obstacles" />
        <operation
            fs="fluid.splat.rect"
            blend="add"
            IGNORE_OBSTACLES="1"
            in_splatPoint="128.0,58.0"
            in_splatSize="10.0,49.0"
            in_splatValue="1.0,0.0,0.0"
            out="obstacles" />

        <operation
            fs="fluid.liquid.distanceToHeight"
            in_liquidHeight="100.0"
            out="initialLevelSet" />
        <operation
            fs="fluid.liquid.distanceToHeight"
            out="levelSet" />
    </init>
    
    <!-- Pipeline stages are evaluated sequential each frame. -->
    <loop>
        <!-- Advection transports quantities in the medium. -->
        <operation
            fs="fluid.advect"
            in_quantityLoss="0.0"
            in_decayAmount="1.0"
            in_treatAsLiquid="0"
            in_obstaclesBuffer="obstacles"
            in_levelSetBuffer="levelSet"
            in_velocityBuffer="velocity"
            in_quantityBuffer="levelSet"
            out="levelSet" />
        <operation
            fs="fluid.advect"
            in_treatAsLiquid="1"
            in_obstaclesBuffer="obstacles"
            in_levelSetBuffer="levelSet"
            in_velocityBuffer="velocity"
            in_quantityBuffer="velocity"
            out="velocity" />

        <!-- Insert liquid -->
        <operation
            fs="fluid.liquid.stream"
            blend="add"
            in_streamCenter="48.0,235.0"
            in_streamRadius="12.8"
            in_streamValue="-40.0"
            in_streamUseValue="true"
            in_obstaclesBuffer="obstacles"
            out="levelSet" />
        <operation
            fs="fluid.liquid.stream"
            blend="add"
            in_streamCenter="198.0,185.0"
            in_streamRadius="12.8"
            in_streamValue="-40.0"
            in_streamUseValue="true"
            in_obstaclesBuffer="obstacles"
            out="levelSet" />

        <!-- pressure solve. -->
        <operation
            fs="fluid.divergence"
            in_halfInverseCellSize="0.4"
            in_velocityBuffer="velocity"
            in_obstaclesBuffer="obstacles"
            out="divergence" />
        <operation
            fs="fluid.pressure"
            iterations="80"
            clearColor="0.0"
            in_alpha="-1.3"
            in_inverseBeta="0.25"
            in_pressureBuffer="pressure"
            in_divergenceBuffer="divergence"
            in_obstaclesBuffer="obstacles"
            in_levelSetBuffer="levelSet"
            out="pressure" />
        <operation
            fs="fluid.substractGradient"
            in_gradientScale="1.0"
            in_velocityBuffer="velocity"
            in_pressureBuffer="pressure"
            in_obstaclesBuffer="obstacles"
            in_levelSetBuffer="levelSet"
            out="velocity" />

        <!--
        <operation
            fs="fluid.liquid.redistance"
            iterations="11"
            in_gradientScale="6.0"
            in_initialLevelSetBuffer="initialLevelSet"
            in_levelSetBuffer="levelSet"
            out="levelSet" />
        -->

        <operation
            fs="fluid.extrapolate"
            iterations="10"
            in_gradientScale="3.3"
            in_velocityBuffer="velocity"
            in_levelSetBuffer="levelSet"
            in_obstaclesBuffer="obstacles"
            out="velocity" />

        <operation name="fluid.gravity"
            fs="fluid.gravity"
            blend="add"
            in_gravityValue="0.0,-1.0,0.0"
            in_levelSetBuffer="levelSet"
            in_obstaclesBuffer="obstacles"
            out="velocity" />

        <!-- visualize -->
        <operation
            fs="sample.levelSet"
            in_quantity="levelSet"
            in_texelFactor="1.0"
            in_colorPositive="0.05,0.125,0.415"
            in_colorNegative="0.2,0.2,0.2"
            out="output" />
        <operation
            fs="sample.removeLines"
            in_quantity="output"
            in_removeColor="0.2,0.2,0.2"
            out="output" />
        <operation
            fs="sample.smooth"
            in_quantity="output"
            out="output" />
        <operation
            fs="sample.smooth"
            in_quantity="output"
            out="output" />
        <!-- draw obstacles -->
        <operation
            fs="sample.scalar"
            blend="alpha"
            in_quantity="obstacles"
            in_texelFactor="1.0"
            in_colorPositive="0.8,0.7,0.6"
            in_colorNegative="0.0"
            out="output" />
    </loop>
</texture-updater>
