<?xml version="1.0" encoding="UTF-8" ?>

<texture-updater
    name="rgb smoke 256x256"
    framerate="60"
    TIMESTEP="0.1"
>
    <!-- Named buffers used in fluid simulation. -->
    <buffers>
        <buffer name="velocity"     components="2" count="2"
                pixelType="16F" size="256,256" />
        <buffer name="vorticity"    components="2" count="2"
                pixelType="16F" size="256,256" />
        <buffer name="density"      components="1" count="2"
                pixelType="16F" size="256,256" />
        <buffer name="temperature"  components="1" count="2"
                pixelType="16F" size="256,256" />
        <buffer name="pressure"     components="1" count="2"
                pixelType="16F" size="256,256" />
        <buffer name="rgb"          components="3" count="2"
                pixelType="16F" size="256,256" />
        <buffer name="divergence"   components="1" count="1"
                pixelType="16F" size="256,256" />
        <buffer name="obstacles"    components="3" count="1"
                pixelType="16F" size="256,256" />
        <buffer name="fluid"        components="3" count="1"
                pixelType="16F" size="256,256" />
        <buffer name="splat" file="res/textures/splat.jpg" />
    </buffers>

    <!-- splat obstacles -->
    <operation
        fs="fluid.splat.border"
        mode="newState"
        IGNORE_OBSTACLES="1"
        in_splatBorder="1.0"
        in_splatValue="1.0,0.0,0.0"
        out="obstacles" />

    <!-- Pipeline stages are evaluated sequential each frame. -->
    <operations>
        <!-- Advection transports quantities in the medium. -->
        <operation
            fs="fluid.advect"
            mode="newState"
            in_quantityLoss="0.0"
            in_decayAmount="0.999"
            in_velocityBuffer="velocity"
            in_quantityBuffer="velocity"
            in_obstaclesBuffer="obstacles"
            out="velocity" />
        <operation
            fs="fluid.advect"
            mode="newState"
            in_quantityLoss="0.0"
            in_decayAmount="0.999"
            in_velocityBuffer="velocity"
            in_quantityBuffer="temperature"
            in_obstaclesBuffer="obstacles"
            out="temperature" />
        <operation
            fs="fluid.advect"
            mode="newState"
            in_quantityLoss="0.0"
            in_decayAmount="0.98"
            in_velocityBuffer="velocity"
            in_quantityBuffer="density"
            in_obstaclesBuffer="obstacles"
            out="density" />
        <operation
            fs="fluid.advect"
            mode="newState"
            in_quantityLoss="0.0"
            in_decayAmount="0.97"
            in_velocityBuffer="velocity"
            in_quantityBuffer="rgb"
            in_obstaclesBuffer="obstacles"
            out="rgb" />

        <!-- Swirl -->
        <operation
            fs="fluid.vorticity.compute"
            mode="newState"
            in_velocityBuffer="velocity"
            out="vorticity" />
        <operation
            fs="fluid.vorticity.confinement"
            mode="modifyState"
            blend="add"
            in_confinementScale="0.5"
            in_vorticityBuffer="vorticity"
            in_obstaclesBuffer="obstacles"
            out="velocity" />

        <!-- Splatting adds quantities each frame. -->
        <operation
            fs="fluid.splat.tex"
            mode="modifyState"
            blend="add"
            in_splatTexture="splat"
            in_texelFactor="3.0"
            in_obstaclesBuffer="obstacles"
            out="temperature" />
        <operation
            fs="fluid.splat.tex"
            mode="modifyState"
            blend="add"
            in_texelFactor="1.0"
            in_splatTexture="splat"
            in_obstaclesBuffer="obstacles"
            out="density" />
        <operation
            fs="fluid.splat.tex"
            mode="modifyState"
            blend="add"
            in_texelFactor="3.0"
            in_splatTexture="splat"
            in_obstaclesBuffer="obstacles"
            out="rgb" />

        <!-- Temperature is an important factor in the flow of many fluids.
             Convection currents are caused by the changes in density associated with temperature changes.
             These currents affect our weather, our oceans and lakes, and even our coffee.
             To simulate these effects, we need to add buoyancy to our simulation. -->
        <operation
            fs="fluid.buoyancy"
            mode="modifyState"
            blend="add"
            in_buoyancy="0.1"
            in_weight="0.019"
            in_ambientTemperature="0.0"
            in_temperatureBuffer="temperature"
            in_densityBuffer="density"
            out="velocity" />

        <!-- pressure solve -->
        <operation
            fs="fluid.divergence"
            mode="newState"
            in_halfInverseCellSize="0.4"
            in_velocityBuffer="velocity"
            in_obstaclesBuffer="obstacles"
            out="divergence" />
        <operation
            fs="fluid.pressure"
            iterations="40"
            mode="newState"
            clearColor="0.0"
            in_alpha="-1.5625"
            in_inverseBeta="0.25"
            in_pressureBuffer="pressure"
            in_divergenceBuffer="divergence"
            in_obstaclesBuffer="obstacles"
            out="pressure" />
        <operation
            fs="fluid.substractGradient"
            mode="newState"
            in_gradientScale="0.89"
            in_velocityBuffer="velocity"
            in_pressureBuffer="pressure"
            in_obstaclesBuffer="obstacles"
            out="velocity" />

        <!-- visualize -->
        <operation
            fs="fluid.visualize.rgb"
            mode="newState"
            in_texelFactor="0.02"
            in_quantity="rgb"
            out="fluid" />
    </operations>
</texture-updater>

