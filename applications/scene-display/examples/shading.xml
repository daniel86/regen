<?xml version="1.0" encoding="UTF-8" ?>

<!-- Framebuffer Objects -->
<fbo id="g-buffer" size-mode="rel" size="1.0,1.0" >
  <texture id="diffuse0"
	   pixel-type="UNSIGNED_BYTE"
	   pixel-size="16"
	   pixel-components="4" />
  <texture id="diffuse1"
	   pixel-type="UNSIGNED_BYTE"
	   pixel-size="16"
	   pixel-components="4" />
  <texture id="specular"
	   pixel-type="UNSIGNED_BYTE"
	   pixel-size="16"
	   pixel-components="4" />
  <texture id="normal"
	   pixel-type="UNSIGNED_BYTE"
	   pixel-size="16"
	   pixel-components="4" />
  <depth id="depth" pixel-size="24" />
</fbo>
<!-- Textures -->
<texture id="regen-logo" file="res/logo.png" />
<texture id="ground-color" file="res/textures/brick/color.jpg" />
<texture id="ground-normal" file="res/textures/brick/normal.jpg" />
<texture id="ground-height" file="res/textures/brick/height.jpg" />
<texture id="rain-database" is-array="1"
	 file="res/textures/rain" name-pattern=".*.png" />
<!-- Fonts -->
<font id="obelix"
      file="res/fonts/obelix.ttf"
      size="16" dpi="96" />
<!-- Cameras -->
<camera id="main-camera"
	fov="45.0" near="0.1" far="200.0"
	position="0.0,1.5,-8.0"
	direction="0.0,-0.25,1.0" />
<!-- Some meshes -->
<mesh id="earth-sky"
      type="sky"
      preset="earth"
      day-length="0.8"
      max-elevation="20.0"
      min-elevation="-20.0"
      day-time="0.5" />
<mesh id="bowl"
      type="half-sphere"
      lod="4"
      scaling="10.0,3.0,7.5"
      use-normal="1"
      use-tangent="0"
      usage="STATIC">
  <define key="HAS_TWO_SIDES" value="TRUE" />
  <material preset="jade"/>
  <transform shape="triangle-mesh" mesh="bowl" mass="0.0">
    <translate value="0.0,-1.0,0.0" />
  </tranform>
</mesh>
<mesh id="sphere-mesh0"
      type="sphere"
      lod="4"
      scaling="0.5,0.5,0.5"
      texco-scaling="1.0,1.0"
      use-normal="1"
      use-tangent="0"
      usage="STATIC">
  <transform shape="sphere" radius="0.5" mass="0.5" inertia="0.0,0.0,0.0" friction="0.005">
    <translate value="0.45,1.0,0.0" />
  </tranform>
</mesh>
<mesh id="sphere-mesh1"
      type="sphere"
      lod="4"
      scaling="0.75,0.75,0.75"
      texco-scaling="1.0,1.0"
      use-normal="1"
      use-tangent="0"
      usage="STATIC">
  <material preset="ruby" />
  <transform shape="sphere" radius="0.75" mass="1.0" inertia="0.0,0.0,0.0" friction="0.005">
    <translate value="0.0,2.5,0.0" />
  </tranform>
</mesh>
<mesh id="rain-particles"
      type="particles"
      num-vertices="50000"
      update-shader="regen.particles.rain.update">
  <!-- Add shader input. -->
  <input type="vec3" name="wind" value="-0.8,-4.5,0" />
  <input type="vec3" name="rainVelocity" value="0.5,0.75,0.5" />
  <input type="vec2" name="rainBrightness" value="5.0,2.0" />
  <input type="vec2" name="rainCone" value="60.0,30.0" />
  <input name="cameraPosition" state="main-camera" component="cameraPosition" />
  <!-- Add particle attributes. -->
  <input type="vec3" name="pos" is-attribute="1" />
  <input type="vec3" name="velocity" is-attribute="1" />
  <input type="int" name="type" is-attribute="1" />
  <input type="float" name="brightness" is-attribute="1" />
</mesh>

<mesh id="logo-widget"
      type="rectangle"
      lod="0"
      rotation="1.57,0.0,0.0"
      scaling="90.0,1.0,23.0"
      texco-scaling="-1.0,1.0"
      use-normal="0"
      use-texco="1"
      use-tangent="0"
      center="0" />
<mesh id="fps-widget"
      type="text"
      font="obelix"
      text="0 FPS"
      text-color="0.97,0.86,0.77,0.95" />

<!--**************************-->
<!--**************************-->

<node id="main-pass">
  <node id="geometry-pass">
    <blend mode="src" />
    <depth test="1" write="1" />
    <fbo id="g-buffer" draw-buffers="0,2,3" />
    
    <node id="sphere0" >
      <mesh id="sphere-mesh0" shader="regen.models.mesh" />
    </node>
    
    <node id="sphere1" >
      <mesh id="sphere-mesh1" shader="regen.models.mesh" />
    </node>
    
    <node id="bowl" >
      <toggle key="CULL_FACE" value="0" />
      <mesh id="bowl" shader="regen.models.mesh" />
    </node>
  </node>
  
  <node>
    <fbo id="g-buffer" draw-buffers="1" />
    <!-- Compute illumination -->
    <node import="shading-pass" />
    <!-- Render background (sky,...) -->
    <node import="background-pass" />
    <node import="rain-pass" />
  </node>
  
  <node>
  </node>
</node>

<node id="rain-pass">
  <direct-shading ambient="0.3,0.3,0.3" >
    <!-- Define lights used for direct shading. -->
    <direct-lights>
      <light id="earth-sky" />
    </direct-lights>
    
    <direct-pass>
	<node id="particle-draw">
	  <blend mode="add" />
	  <depth test="1" write="0" />
	  <define key="USE_RAIN_DB" value="TRUE" />
	  
	  <texture name="depthTexture" fbo="g-buffer" attachment="depth" />
	  <texture name="rainDB" id="rain-database" />
	  <input type="vec2" name="particleSize" value="0.07,5.0" />
	  
	  <mesh id="rain-particles" shader="regen.particles.rain.draw" />
	</node>
    </direct-pass>
  </direct-shading>
</node>

<node id="shading-pass">
  <blend mode="add" />
  <depth test="0" write="0" />
  
  <texture name="gDepthTexture" fbo="g-buffer" attachment="depth" />
  <texture name="gDiffuseTexture" fbo="g-buffer" attachment="0" />
  <texture name="gSpecularTexture" fbo="g-buffer" attachment="2" />
  <texture name="gNorWorldTexture" fbo="g-buffer" attachment="3" />
  <input type="vec3" name="lightAmbient" value="0.1,0.1,0.1" />
    
  <node>
    <fullscreen-pass shader="regen.shading.deferred.ambient" />

    <light-pass type="DIRECTIONAL" shader="regen.shading.deferred.directional">
      <light id="earth-sky" />
    </light-pass>
    
  </node>
</node>

<node id="background-pass">
  <depth test="1" write="0" />
  
  <node id="sky-node">
    <mesh id="earth-sky" />
  </node>
</node>

<!--**************************-->
<!--**************************-->

<node id="post-pass">
  <depth test="0" write="0" />
  
  <node id="fxaa">
    <fbo id="g-buffer" draw-buffers="0" />
    <texture name="inputTexture" fbo="g-buffer" attachment="1" />
    <input type="float" name="spanMax" value="8.0" />
    <input type="float" name="reduceMul" value="0.125" />
    <input type="float" name="reduceMin" value="0.0078125" />
    <input type="vec3" name="luma" value="0.299,0.587,0.114" />
    
    <fullscreen-pass shader="regen.filter.fxaa" />
  </node>
</node>

<!--**************************-->
<!--**************************-->

<node id="gui-pass">
  <blend mode="alpha" />
  <depth test="0" write="0" />
  <fbo id="g-buffer" draw-buffers="0" />
  
  <node id="logo-widget">
    <transform>
      <translate value="8.0,-8.0,0.0" />
    </transform>
    <material alpha="0.7" />
    <texture id="regen-logo" map-to="COLOR" blend="SRC" />
    <define key="INVERT_Y" value="TRUE" />
    <define key="INVERT_X" value="FALSE" />
    <mesh id="logo-widget" shader="regen.gui.widget" />
  </node>
  
  <node id="fps-widget">
    <transform>
      <translate value="8.0,8.0,0.0" />
    </transform>
    <mesh id="fps-widget" />
  </node>
</node>

<!--**************************-->
<!--**************************-->

<node id="root">
  <fbo id="g-buffer" clear-buffers="0,1,2,3" clear-depth="1" />
  <camera id="main-camera" />
  
  <node import="main-pass" />
  <node import="post-pass" />
  <node import="gui-pass" />
  <node>
    <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN" />
  </node>
</node>
