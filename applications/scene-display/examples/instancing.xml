<?xml version="1.0" encoding="UTF-8" ?>

<!-- Framebuffer Objects -->
<fbo id="g-buffer" size-mode="rel" size="1.0,1.0" >
  <texture id="diffuse0"
	   pixel-type="UNSIGNED_BYTE"
	   pixel-size="16"
	   pixel-components="4" />
  <texture id="diffuse1"
	   pixel-type="UNSIGNED_BYTE"
	   pixel-size="16"
	   pixel-components="4" />
  <texture id="specular"
	   pixel-type="UNSIGNED_BYTE"
	   pixel-size="16"
	   pixel-components="4" />
  <texture id="normal"
	   pixel-type="UNSIGNED_BYTE"
	   pixel-size="16"
	   pixel-components="4" />
  <depth id="depth" pixel-size="24" />
</fbo>
<!-- Textures -->
<texture id="regen-logo" file="res/logo.png" />
<texture id="random-normal" file="res/textures/random_normals.png" />
<texture id="sky-cube" sky="earth-sky" />
<texture id="ground-color" file="res/textures/brick/color.jpg" />
<texture id="ground-normal" file="res/textures/brick/normal.jpg" />
<texture id="ground-height" file="res/textures/brick/height.jpg" />
<!-- Fonts -->
<font id="obelix"
      file="res/fonts/obelix.ttf"
      size="16" dpi="96" />
<!-- Cameras -->
<camera id="main-camera"
	fov="45.0" near="0.1" far="200.0"
	position="1.0,2.0,-50.0"
	direction="0.0,0.0,1.0" />
<!-- Lights -->
<light id="sun-light" sky="earth-sky" />
<!-- Shadow Maps -->
<shadow-map id="sun-shadow"
	    light="sun-light"
	    camera="main-camera"
	    size="1024"
	    pixel-size="24"
	    pixel-type="FLOAT"
	    num-layer="3"
	    split-weight="0.9" />
<!-- Some asset files. Assets can contain lights,materials and meshes. -->
<asset id="animation-asset"
       type="asset"
       file="res/models/psionic/dwarf/x/dwarf.x"
       texture-path="res/models/psionic/dwarf/x"
       use-animation="1"
       animation-force-states="1"
       animation-post-state="LINEAR"
       animation-pre-state="LINEAR"
       animation-tps="20.0"
       animation-instances="50">
  <!-- Optionally define named animation ranges. -->
  <anim-range name="complete"    range="0.0,361.0" />
  <anim-range name="run"         range="16.0,26.0" />
  <anim-range name="jump"        range="28.0,40.0" />
  <anim-range name="jumpSpot"    range="42.0,54.0" />
  <anim-range name="crouch"      range="56.0,59.0" />
  <anim-range name="crouchLoop"  range="60.0,69.0" />
  <anim-range name="getUp"       range="70.0,74.0" />
  <anim-range name="battleIdle1" range="75.0,88.0" />
  <anim-range name="battleIdle2" range="90.0,110.0" />
  <anim-range name="attack1"     range="112.0,126.0" />
  <anim-range name="attack2"     range="128.0,142.0" />
  <anim-range name="attack3"     range="144.0,160.0" />
  <anim-range name="attack4"     range="162.0,180.0" />
  <anim-range name="attack5"     range="182.0,192.0" />
  <anim-range name="block"       range="194.0,210.0" />
  <anim-range name="dieFwd"      range="212.0,227.0" />
  <anim-range name="dieBack"     range="230.0,251.0" />
  <anim-range name="yes"         range="253.0,272.0" />
  <anim-range name="no"          range="274.0,290.0" />
  <anim-range name="idle1"       range="292.0,325.0" />
  <anim-range name="idle2"       range="327.0,360.0" />
</asset>
<!-- Some meshes. -->
<mesh id="earth-sky"
      type="sky"
      preset="earth"
      dayLength="0.8"
      maxElevation="20.0"
      minElevation="-20.0"
      dayTime="0.5" />
<mesh id="ground-mesh"
      type="rectangle"
      lod="0"
      rotation="0.0,0.0,3.1415"
      scaling="100.0,100.0,100.0"
      texco-scaling="20.0,20.0"
      use-normal="1"
      use-texco="1"
      use-tangent="1"
      center="1"
      usage="STATIC" />
<mesh id="dwarf-axe"
      type="asset"
      asset="animation-asset"
      asset-indices="0"
      asset-material="0"
      asset-animation="1" />
<mesh id="dwarf-body"
      type="asset"
      asset="animation-asset"
      asset-indices="1"
      asset-material="0"
      asset-animation="1" />
  
<!--**************************-->
<!--**************************-->

<node id="main-pass">
  <node id="geometry-pass">
    <blend mode="src" />
    <depth test="1" write="1" />
    <fbo id="g-buffer">
      <draw-buffer attachments="0,2,3" />
    </fbo>
    
    <node id="dwarf-node" num-instances="100" >
      <transform is-instanced="1" >
	<distribute mode="fade" target="scale"
	       start="1.0,1.0,1.0" stop="1.25,1.25,1.25"
	       random-indices="75" />
	<distribute mode="row" target="translate"
	       x-step="8.0,0.0,0.0" x-count="10"
	       z-step="0.0,0.0,8.0" />
	<translate value="-40.0,-2.0,-40.0" />
      </transform>
      <input type="int" name="boneOffset" is-instanced="1">
	<distribute mode="random" min="0" max="49"/>
      </input>
      
      <node id="dwarf-axe" shadow-maps="*" >
	<material asset="animation-asset" asset-index="0" />
	<!-- Overwrite src blending defines from imported material. -->
	<define key="TEX_BLEND_KEY1" value="regen.utility.blending.add" />
	<define key="TEX_BLEND_NAME1" value="blend_add" />
	<!-- Make some axes green. -->
	<input type="vec3" name="matDiffuse" is-instanced="1">
	  <distribute mode="constant" value="0.0,1.0,0.0" random-indices="20" />
	  <distribute mode="constant" value="1.0,0.0,0.0" random-indices="20" />
	</input>
	<mesh id="dwarf-axe" shader="regen.meshes.mesh" />
      </node>
      
      <node id="dwarf-body" shadow-maps="*" >
	<material asset="animation-asset" asset-index="1" />
	<mesh id="dwarf-body" shader="regen.meshes.mesh" />
      </node>
    </node>
    
    <node id="ground">
      <input type="float" name="parallaxBias" value="0.015" />
      <input type="float" name="parallaxScale" value="0.03" />
      <texture name="colorTexture" id="ground-color" map-to="COLOR"
	       texco-transfer="PARALLAX" />
      <texture name="normalTexture" id="ground-normal" map-to="NORMAL"
	       texco-transfer="PARALLAX"
	       texel-transfer-key="regen.utility.textures.normalTBNTransfer" />
      <texture name="heightTexture" id="ground-height" />
      
      <transform>
	<translate value="0.0,-2.0,0.0" />
      </transform>
      <material ambient="0.3,0.3,0.3"
		diffuse="0.7,0.7,0.7" />
      <mesh id="ground-mesh" shader="regen.meshes.mesh" />
    </node>
  </node>
  
  <node>
    <fbo id="g-buffer">
      <draw-buffer attachments="1" />
    </fbo>
    <!-- Compute illumination -->
    <node import="shading-pass" />
    <!-- Render background (sky,...) -->
    <node import="background-pass" />
  </node>
</node>

<node id="shading-pass">
  <blend mode="add" />
  <depth test="0" write="0" />
  
  <texture name="gDepthTexture" fbo="g-buffer" attachment="depth" />
  <texture name="gDiffuseTexture" fbo="g-buffer" attachment="0" />
  <texture name="gSpecularTexture" fbo="g-buffer" attachment="2" />
  <texture name="gNorWorldTexture" fbo="g-buffer" attachment="3" />
  <input type="vec3" name="lightAmbient" value="0.1,0.1,0.1" />
    
  <state-sequence>
    <fullscreen-pass shader="regen.shading.deferred.ambient" />

    <light-pass type="DIRECTIONAL"
		shader="regen.shading.deferred.directional"
		use-shadows="1"
		shadow-filter="NONE"
		shadow-layer="3">
      <light id="sun-light" shadow-map="sun-shadow" />
    </light-pass>
  </state-sequence>
  
  <node id="ambient-occlusion-update">
    <blend mode="src" />
    <input type="int" name="numBlurPixels" value="3" />
    <input type="float" name="blurSigma" value="3.0" />
    <input type="float" name="aoSamplingRadius" value="50.0" />
    <input type="float" name="aoBias" value="0.28" />
    <input type="vec2" name="aoAttenuation" value="0.1,0.2" />
    <texture name="aoNoiseTexture" id="random-normal" />
    
    <filter-sequence id="ambient-occlusion"
		     fbo="g-buffer" attachment="3"
		     format="RED"
		     internal-format="R16"
		     pixel-type="BYTE"
		     bind-input="0" >
      <filter shader="regen.shading.ssao" scale="0.5" />
      <filter shader="regen.post-passes.blur.horizontal" />
      <filter shader="regen.post-passes.blur.vertical" />
    </filter-sequence>
  </node>
  <node id="ambient-occlusion-sample">
    <blend mode="mul" />
    <texture name="aoTexture" filter="ambient-occlusion" />
    <fullscreen-pass shader="regen.shading.ssao.sample" />
  </node>
</node>

<node id="background-pass">
  <depth test="1" write="0" />
  
  <node id="sky-node">
    <mesh id="earth-sky" />
  </node>
  
  <node id="distance-fog">
    <blend mode="alpha" />
    <input type="float" name="fogDensity" value="1.0" />
    <input type="vec2" name="fogDistance" value="0.0,100.0" />
    <input type="vec3" name="fogColor" value="1.0,1.0,1.0" />
    <texture name="gDepthTexture" fbo="g-buffer" attachment="depth" />
    <texture name="skyColorTexture" id="sky-cube" />
    <define key="USE_SKY_COLOR" value="TRUE" />
    
    <fullscreen-pass shader="regen.shading.fog.distance" />
  </node>
</node>

<!--**************************-->
<!--**************************-->

<node id="post-pass">
  <depth test="0" write="0" />
  
  <node id="blur">
    <input type="int" name="numBlurPixels" value="4" />
    <input type="float" name="blurSigma" value="2.0" />
    
    <filter-sequence id="blurred-scene" fbo="g-buffer" attachment="1" >
      <filter shader="regen.utility.sampling.downsample" scale="0.5" />
      <filter shader="regen.post-passes.blur.horizontal" />
      <filter shader="regen.post-passes.blur.vertical" />
    </filter-sequence>
  </node>
  
  <node id="depth-of-field">
    <fbo id="g-buffer">
      <draw-buffer attachments="0" />
    </fbo>
    <texture name="inputTexture" fbo="g-buffer" attachment="1" />
    <texture name="depthTexture" fbo="g-buffer" attachment="depth" />
    <texture name="blurTexture" filter="blurred-scene" />
    <input type="float" name="focalDistance" value="0.0" />
    <input type="vec2" name="focalWidth" value="0.7,1.0" />
    <fullscreen-pass shader="regen.post-passes.dof" />
  </node>
  
  <node id="fxaa">
    <fbo id="g-buffer">
      <draw-buffer attachments="1" />
    </fbo>
    <texture name="inputTexture" fbo="g-buffer" attachment="0" />
    <input type="float" name="spanMax" value="8.0" />
    <input type="float" name="reduceMul" value="0.125" />
    <input type="float" name="reduceMin" value="0.0078125" />
    <input type="vec3" name="luma" value="0.299,0.587,0.114" />
    
    <fullscreen-pass shader="regen.post-passes.fxaa" />
  </node>
</node>

<!--**************************-->
<!--**************************-->

<node id="gui-pass">
  <blend mode="alpha" />
  <depth test="0" write="0" />
  <fbo id="g-buffer">
    <draw-buffer attachments="1" />
  </fbo>
  
  <node id="logo-widget">
    <transform>
      <translate value="8.0,-8.0,0.0" />
    </transform>
    <texture-box h-alignment="left"
		 v-alignment="bottom"
		 texture="regen-logo"
		 size="0.1,0.1" />
  </node>
  
  <node id="fps-widget">
    <transform>
      <translate value="8.0,8.0,0.0" />
    </transform>
    <text-box h-alignment="left"
	      v-alignment="top"
	      font="obelix"
	      text="0 FPS"
	      textColor="0.97,0.86,0.77,0.95" />
  </node>
</node>

<!--**************************-->
<!--**************************-->

<node id="root">
  <fbo id="g-buffer">
    <clear-buffer attachments="0,1,2,3" />
    <clear-depth />
  </fbo>
  <camera id="main-camera" />
  
  <node import="main-pass" />
  <node import="post-pass" />
  <node import="gui-pass" />
  <node>
    <blit fbo="g-buffer" attachment="1" />
  </node>
</node>
