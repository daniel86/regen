<?xml version="1.0" encoding="UTF-8" ?>

<gui-config ego-camera="0"
	    look-at-camera="1"
	    look-at="0.0,0.0,0.0"
	    look-at-height="0.0"
	    look-at-radius="2.0"
	    look-at-degree="0.0"
	    look-at-step="0.001"
	    look-at-scroll-step="0.05"
	    look-at-step-x="0.02"
	    look-at-step-y="0.001"
	    look-at-interval="10"
	    />

<include xml-file="scene-display/examples/default.xml" />

<!-- Textures -->
<texture id="hdr-texture"
	 is-cube="1"
	 cube-flip-back="1"
	 file="res/textures/cube-maps/grace.hdr"
	 min-filter="LINEAR_MIPMAP_LINEAR"
	 mag-filter="LINEAR"
	 wrapping="CLAMP_TO_EDGE"
	 forced-internal-format="R11F_G11F_B10F"
	 aniso="2.0" />
<!-- Cameras -->
<camera id="main-camera"
	fov="45.0" near="0.1" far="200.0"
	position="0.0,0.0,-2.0"
	direction="0.0,0.0,1.0" />
<!-- Some meshes. -->
<mesh id="sky-box"
      type="box"
      use-normal="0"
      use-tangent="0"
      texco-mode="CUBE_MAP"
      usage="STATIC" />
<mesh id="sprite-sphere"
      type="mesh"
      primitive="POINTS"
      usage="STATIC"
      num-vertices="1" >
  <input type="float" name="sphereRadius" is-attribute="1">
    <set mode="constant" value="1.0" index="0" />
  </input>
  <input type="vec3" name="pos" is-attribute="1">
    <set mode="constant" value="0.0,0.0,0.0" index="0" />
  </input>
</mesh>
  
<!--**************************-->
<!--**************************-->

<node id="main-pass">
  <node id="geometry-pass">
    <blend mode="src" />
    <depth test="1" write="1" />
    <fbo id="g-buffer-float" draw-buffers="0,2,3" />
    
    <node id="sphere-node" >
      <transform />
      <material />
      <texture id="hdr-texture"
	       map-to="COLOR"
	       blend-mode="SRC"
	       mapping="CUBE_REFRACTION" />
      <texture id="hdr-texture"
	       map-to="COLOR"
	       blend-mode="MIX"
	       blend-factor="0.35"
	       mapping="CUBE_REFLECTION" />
      <mesh id="sprite-sphere" shader="regen.models.sprite-sphere" />
    </node>
  </node>
  <view id="Scene -- Sphere">
    <blit src-fbo="g-buffer-float" src-attachment="0" dst-fbo="SCREEN" />
  </view>
  
  <node>
    <fbo id="g-buffer-float" draw-buffers="0" />
    <depth test="1" write="0" />
    
    <!-- Render background (sky,...) -->
    <node id="sky-node">
      <cull mode="front" />
      <depth function="LEQUAL" />
      <define key="IGNORE_VIEW_TRANSLATION" value="TRUE" />
      <texture id="hdr-texture" map-to="COLOR" />
      <mesh id="sky-box" shader="regen.models.sky-box" />
    </node>
  </node>
  <view id="Scene -- Background">
    <blit src-fbo="g-buffer-float" src-attachment="0" dst-fbo="SCREEN" />
  </view>
</node>

<!--**************************-->
<!--**************************-->

<node id="post-pass">
  <depth test="0" write="0" />
  
  <node id="blur">
    <input type="int" name="numBlurPixels" value="10" />
    <input type="float" name="blurSigma" value="2.5" />
    
    <filter-sequence id="blurred-scene" fbo="g-buffer-float" attachment="0" >
      <filter shader="regen.filter.sampling" scale="0.5" />
      <filter shader="regen.filter.blur.horizontal" />
      <filter shader="regen.filter.blur.vertical" />
    </filter-sequence>
  </node>
  
  <node id="tonemap">
    <define key="USE_RADIAL_BLUR" value="TRUE" />
    <define key="USE_VIGNETTE" value="TRUE" />
    <fbo id="g-buffer-float" draw-buffers="1" />
    <texture name="inputTexture" fbo="g-buffer-float" attachment="0" />
    <texture name="blurTexture" id="blurred-scene" />
    
    <input type="float" name="blurAmount" value="0.5" />
    <input type="float" name="effectAmount" value="0.2" />
    <input type="float" name="exposure" value="16.0" />
    <input type="float" name="gamma" value="0.5" />
    <input type="float" name="radialBlurSamples" value="36.0" />
    <input type="float" name="radialBlurStartScale" value="1.0" />
    <input type="float" name="radialBlurScaleMul" value="0.9555" />
    <input type="float" name="vignetteInner" value="0.7" />
    <input type="float" name="vignetteOuter" value="1.5" />
    
    <fullscreen-pass shader="regen.filter.tonemap" />
  </node>
  
  <view id="Scene -- Tonemap">
    <blit src-fbo="g-buffer-float" src-attachment="1" dst-fbo="SCREEN" />
  </view>
</node>

<!--**************************-->
<!--**************************-->

<node id="root">
  <fbo id="g-buffer-float" clear-buffers="0,1,2,3" clear-depth="1" />
  <camera id="main-camera" />
  
  <node import="main-pass" />
  <node import="post-pass" />
  
  <node id="GUI">
    <fbo id="g-buffer-float" draw-buffers="1" />
    <node import="gui-pass" />
  </node>
  
  <view id="Scene -- Result">
    <blit src-fbo="g-buffer-float" src-attachment="1" dst-fbo="SCREEN" />
  </view>
</node>
