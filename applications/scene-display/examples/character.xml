<?xml version="1.0" encoding="UTF-8" ?>

<include xml-file="scene-display/examples/templates/default.xml"/>

<node id="configuration">
    <animation id="dwarf-asset" type="asset" idle="idle2">
        <key-mapping key=" " press="jumpSpot"/>
        <key-mapping key="C" press="crouch" idle="crouchLoop" toggle="1"/>
        <key-mapping key="W" press="walk" interrupt="1" release-interrupt="1"/>
        <key-mapping key="A" press="walk" interrupt="1" release-interrupt="1"/>
        <key-mapping key="S" press="walk" interrupt="1" release-interrupt="1" backwards="1"/>
        <key-mapping key="D" press="walk" interrupt="1" release-interrupt="1"/>
        <mouse-mapping button="1" press="attack1" />
        <mouse-mapping button="2" press="block" />
    </animation>
    <camera id="main-camera"
            mode="third-person"
            type="physical-character"
            step-height="0.8"
            max-slope="0.8"
            collision-radius="0.9"
            collision-height="3.9"
            gravity-force="30.0"
            jump-velocity="16.0"
            mesh="dwarf-mesh"
            mesh-index="1"
            mesh-distance="40.0"
            mesh-horizontal-orientation="3.14159265359"
            vertical-orientation="0.6"
            transform="dwarf-transform"
            eye-offset="0.0,2.75,0.0">
        <key-mapping key="W" command="move_forward" />
        <key-mapping key="A" command="move_left" />
        <key-mapping key="S" command="move_backward" />
        <key-mapping key="D" command="move_right" />
        <key-mapping key=" " command="jump" />
        <key-mapping key="C" command="crouch" />
    </camera>
</node>

        <!-- FBOs -->
<fbo id="g-buffer"
     size-mode="rel" size="1.0,1.0"
     pixel-type="UNSIGNED_BYTE"
     pixel-size="16"
     pixel-components="4" >
  <texture id="diffuse0" />
  <texture id="diffuse1" />
  <texture id="specular" />
  <texture id="normal" />
  <depth id="depth" pixel-size="24" />
</fbo>
        <!-- Textures -->
<texture id="ground-color" file="res/textures/brick/color.jpg"/>
<texture id="ground-normal" file="res/textures/brick/normal.jpg"/>
<texture id="ground-height" file="res/textures/brick/height.jpg"/>
        <!-- Cameras -->
<camera id="main-camera"
        fov="45.0" near="0.1" far="200.0"
        position="25.0,2.5,2.0"
        direction="1.0,0.0,-1.0"/>
        <!-- Lights -->
<light id="room-light0"
       type="POINT"
       position="-5.0,16.0,0.0"
       radius="30.0,48.0"
       direction="0.0,-1.0,0.0"
       diffuse="0.8,0.9,0.835"
       ambient="0.6,0.6,0.6"/>
        <!-- Meshes -->

<transform id="ground-transform">
        <translate value="0.0,-2.0,0.0"/>
</transform>
<mesh id="ground-mesh" type="rectangle" use-normal="1" use-texco="1" center="1" usage="STATIC" lod="2"
      rotation="0.0,0.0,3.1415"
      scaling="240.0,20.0,240.0">
    <transform id="ground-transform" />
    <material preset="pewter"/>
</mesh>

<transform id="dwarf-transform">
    <rotate value="1.5707963,0.0,0.0"/>
    <translate value="2.0,0.0,0.0"/>
</transform>
<mesh id="dwarf-mesh" type="asset" asset="dwarf-asset" asset-indices="*" asset-animation="1">
    <transform id="dwarf-transform"/>
</mesh>

        <!--**************************-->
        <!--********* Stairs *********-->
        <!--**************************-->

<transform id="stairs0-tf">
    <translate value="16.0,-1.6,16.0"/>
</transform>
<transform id="stairs1-tf">
    <translate value="16.0,-0.8,16.0"/>
</transform>
<transform id="stairs2-tf">
    <translate value="16.0,0.0,16.0"/>
</transform>

<mesh id="stairs0-mesh" type="box" use-normal="1" center="1" usage="STATIC" scaling="8.0,0.4,4.0">
    <transform id="stairs0-tf" />
    <material preset="copper"/>
</mesh>
<mesh id="stairs1-mesh" type="box" use-normal="1" center="1" usage="STATIC" scaling="6.0,0.4,4.0">
    <transform id="stairs1-tf" />
    <material preset="copper"/>
</mesh>
<mesh id="stairs2-mesh" type="box" use-normal="1" center="1" usage="STATIC" scaling="4.0,0.4,4.0">
    <transform id="stairs2-tf" />
    <material preset="copper"/>
</mesh>

<node id="Stairs">
    <node id="stairs0">
        <physics mesh-id="stairs0-mesh" transform-id="stairs0-tf" shape="box" mass="0.0"
             size="16.0,0.8,8.0"/>
        <mesh id="stairs0-mesh" shader="regen.models.mesh"/>
    </node>
    <node id="stairs1">
        <physics mesh-id="stairs1-mesh" transform-id="stairs1-tf" shape="box" mass="0.0"
             size="12.0,0.8,8.0"/>
        <mesh id="stairs1-mesh" shader="regen.models.mesh"/>
    </node>
    <node id="stairs2">
        <physics mesh-id="stairs2-mesh" transform-id="stairs2-tf" shape="box" mass="0.0"
             size="8.0,0.8,8.0"/>
        <mesh id="stairs2-mesh" shader="regen.models.mesh"/>
    </node>
</node>

        <!--**************************-->
        <!--******** Platforms *******-->
        <!--**************************-->

<transform id="platform0-tf">
    <translate value="16.0,3.0,-16.0"/>
    <animation type="key-frames" mesh-id="platform0-mesh" dt="2.5">
        <key-frame position="16.0,3.0,8.0"/>
        <key-frame position="16.0,3.0,-16.0"/>
    </animation>
</transform>
<transform id="platform1-tf">
    <translate value="8.0,7.0,-16.0"/>
    <animation type="key-frames" mesh-id="platform1-mesh" dt="2.5">
        <key-frame position="-20.0,7.0,-16.0"/>
        <key-frame position="8.0,7.0,-16.0"/>
    </animation>
</transform>

<mesh id="platform0-mesh" type="box" use-normal="1" center="1" usage="STATIC"
        scaling="4.0,0.4,4.0">
    <transform id="platform0-tf" />
    <material preset="copper"/>
    <physics mesh-id="platform0-mesh" transform-id="platform0-tf"
             shape="box" mass="0.0" size="8.0,0.8,8.0"/>
</mesh>
<mesh id="platform1-mesh" type="box" use-normal="1" center="1" usage="STATIC"
        scaling="4.0,0.4,4.0">
    <transform id="platform1-tf" />
    <material preset="copper"/>
    <physics mesh-id="platform1-mesh" transform-id="platform1-tf"
             shape="box" mass="0.0" size="8.0,0.8,8.0"/>
</mesh>

<node id="Platforms">
    <node id="platform0">
        <mesh id="platform0-mesh" shader="regen.models.mesh"/>
    </node>
    <node id="platform1">
        <mesh id="platform1-mesh" shader="regen.models.mesh"/>
    </node>
</node>

        <!--**************************-->
        <!--**************************-->

<mesh id="statue-platform"
      type="box"
      scaling="3.5,5.0,3.5"
      use-normal="1"
      use-tangent="0"
      center="1"
      usage="STATIC">
  <material preset="copper" />
  <physics mesh-id="statue-platform" transform-id="statue-platform-tf"
        shape="box" size="7.0, 10.0, 7.0" mass="0.0" />
</mesh>

<transform id="statue-platform-tf">
    <rotate value="1.57079632,0.0,0.0"/>
    <translate value="-16.0, 3.0, -3.0"/>
</transform>

<node id="Statues">
    <node id="statue-platform">
        <transform id="statue-platform-tf" />
        <mesh id="statue-platform" shader="regen.models.mesh"/>
    </node>
    <node id="statue-slope">
        <mesh id="slope-mesh" shader="regen.models.mesh"/>
    </node>
</node>

        <!--**************************-->
        <!--***** Slope *****-->
        <!--**************************-->

<transform id="slope-tf">
    <rotate value="0,0, -0.6, 0.0"/>
    <translate value="-16.0, 3.0, 7.9"/>
</transform>
<mesh id="slope-mesh" type="box" use-normal="1" use-texco="1" center="1" usage="STATIC" lod="2"
      rotation="0.0,0.0,0.0"
      scaling="3.5,0.04,9.0">
    <transform id="slope-tf" />
    <material preset="copper"/>
    <physics mesh-id="slope-mesh" transform-id="slope-tf" shape="box" size="7,0.08,18" mass="0.0" />
</mesh>

        <!--**************************-->
        <!--***** Shadow Mapping *****-->
        <!--**************************-->

<fbo id="room-light-shadow0"
     target="TEXTURE_CUBE_MAP"
     sampler-type="samplerCube"
     size-mode="abs" size="2048,2048,6">
    <depth pixel-size="24" pixel-type="FLOAT"
           wrapping="CLAMP_TO_EDGE"
           min-filter="NEAREST" mag-filter="NEAREST"
           compare-mode="COMPARE_R_TO_TEXTURE"
           compare-function="LEQUAL"
           sampler-type="samplerCubeShadow"/>
</fbo>

<camera id="room-light-camera0"
        light="room-light0"
        camera="main-camera"/>

<node id="Shadow-Pass">
    <cull mode="FRONT"/>
    <define key="OUTPUT_TYPE" value="DEPTH"/>

    <node id="Room-Light-Shadow">
        <node id="Room-Light-Shadow0">
            <fbo id="room-light-shadow0" clear-depth="1"/>
            <camera id="room-light-camera0"/>
            <!-- <polygon offset-fill="1.1,4.0" /> -->
            <node import="Shadow-Caster"/>
        </node>
    </node>
</node>

        <!--**************************-->
        <!--**************************-->

<node id="Shadow-Caster">
    <node id="Dwarf" type="cull" mesh="dwarf-mesh" transform="dwarf-transform" shape="sphere">
        <polygon offset-fill="1.1,4.0"/>
        <mesh id="dwarf-mesh" shader="regen.models.mesh"/>
    </node>
    <node import="Scene-Shadow-Caster"/>
</node>

<node id="Scene-Shadow-Caster">
    <node import="Statues"/>
    <node import="Stairs"/>
    <node import="Platforms"/>
</node>

<node id="Scene-Geometry">
    <node id="Ground">
        <physics mesh-id="ground-mesh" transform-id="ground-transform" shape="triangle-mesh" mass="0.0" />
        <mesh id="ground-mesh" shader="regen.models.mesh"/>
    </node>
    <node import="Scene-Shadow-Caster" />
</node>

<node id="Shading-Pass">
    <blend mode="add"/>
    <depth test="0" write="0"/>
    <input type="vec3" name="lightAmbient" value="0.3,0.3,0.3"/>
    <resource id="earth-sky" />

    <node id="Ambient-Shading">
        <fullscreen-pass shader="regen.shading.deferred.ambient"/>
    </node>
    <node id="Light-Shading">
        <light-pass type="DIRECTIONAL" shader="regen.shading.deferred.directional">
            <light id="earth-sky-sun" />
        </light-pass>
        <light-pass type="POINT" shader="regen.shading.deferred.point">
            <light id="room-light0"
                   shadow-buffer="room-light-shadow0" shadow-attachment="depth"
                   shadow-camera="room-light-camera0"/>
        </light-pass>
    </node>
</node>

<node id="Sky">
    <depth test="1" write="0" />
    <sky id="earth-sky" />
</node>

<node id="Background-Pass">
    <node import="Sky" />
</node>

        <!--**************************-->
        <!--**************************-->

<node id="Post-Pass">
    <depth test="0" write="0"/>

    <node import="FXAA">
        <fbo id="g-buffer" draw-buffers="0"/>
        <texture name="inputTexture" fbo="g-buffer" attachment="1"/>
    </node>
    <view id="Antialiased Scene">
        <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
    </view>
</node>

        <!--**************************-->
        <!--**************************-->

<node id="root">
    <node id="Pre-Render">
        <node import="Shadow-Pass"/>

        <view id="Shadow-Map">
            <fbo id="SCREEN"/>
            <texture name="cubeTexture" fbo="room-light-shadow0" attachment="depth"/>
            <fullscreen-pass shader="regen.filter.sampling.cube-shadow-unfold"/>
        </view>
    </node>

    <node id="Render">
        <fbo id="g-buffer" clear-buffers="0,1,2,3" clear-depth="1"/>

        <node import="Default-Pipeline"/>

        <view id="Bullet Debug Draw">
            <node import="bullet-debug">
                <fbo id="g-buffer" draw-buffers="0"/>
            </node>
            <node>
                <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
            </node>
        </view>
        <!--
        <node import="bullet-debug">
            <fbo id="g-buffer" draw-buffers="0"/>
        </node>
        -->

        <node import="GUI-Pass">
            <fbo id="g-buffer" draw-buffers="0"/>
        </node>

        <view id="Output Rendering">
            <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
        </view>
    </node>
</node>
